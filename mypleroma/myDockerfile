FROM elixir:alpine

RUN apk -U upgrade \
    && apk add -t --no-cache build-dependencies \
        build-base \
    && apk add --no-cache git


USER pleroma
WORKDIR /pleroma

EXPOSE 4000

RUN mkdir /pleroma/uploads
RUN /pleroma/config/
RUN /pleroma/priv/

COPY . /pleroma

ENV MIX_ENV prod

RUN cd /pleroma \
    && mix local.hex --force \
    && mix local.rebar --force \
    && mix deps.get \
    && mix compile

VOLUME /pleroma/uploads/
VOLUME /pleroma/config/
VOLUME /pleroma/priv/

CMD ["mix", "phx.server"]